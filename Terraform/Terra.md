# INTRODUCTION TO TERRAFORM

### Trigger terraform using jenkins
  - use docker container as jenkins agent
Jenkins Credentials: 
     - user: s6student
     - password: s6student
     - email: s6student@gmail.com
     - URL: http://server3.anomicatech.com:8080/ 

## Jenkin file
- Dir: Workspace.
This will use the path provided as the workspace
![alt text](<WhatsApp Image 2024-04-22 at 20.50.26_ce58872a.jpg>)

## Authenticate Terraform 
  - create user
  - give user credentials
  - give user permission to auntheticate
  - configure AWS CLI 
        - ```
        aws s3 configure
           ```
- Install plugin in jenkins
   - go to credential
   - search AWS credential
   - grab secret key from aws s3 bucket
   - grab access key
![alt text](<WhatsApp Image 2024-04-22 at 21.06.30_520b2cb8.jpg>)



## Terraform plan: checks if local is similar to aws
   - this is like argocd, 

## Terraform lock.hcl: 

## Terraform State File
The terraform.tfstate file is a crucial component of Terraform, a widely used Infrastructure as Code (IaC) tool. It's automatically generated by Terraform when you run terraform apply to deploy your infrastructure.

Here's what you need to know about terraform.tfstate:

State Management: The terraform.tfstate file serves as Terraform's state management mechanism. It keeps track of the current state of your infrastructure. This includes information about the resources that Terraform manages, their current configurations, and their dependencies.

Locking Mechanism: To prevent concurrent modifications to the state file, Terraform supports state locking. When using a remote backend, Terraform can acquire locks to ensure that only one user or process can modify the state at a time. This prevents conflicts and ensures the integrity of the state file.

The person who launches the state file is the only one who can launch the resorce into AWS. The resource can be Ec2 instance. 

## Terraform Remote Backend
- We push the statefile to the aws s3 bucket
- this means everyone can access it.




- Implement a backend block
   - this is the backend.tf file. 
```
   terraform {
  backend "s3" {
    bucket         = "your-bucket-name"
    key            = "ec2/terraform.tfstae" #create a folder called ec2 and dump my state file here
    region         = "us-west-2"  # Specify the appropriate AWS region
    dynamodb_table = "terraform-lock"  # Optional: Enable DynamoDB locking
    encrypt        = true  # Optional: Encrypt the state file
  }
}
```

## Terraform apply
- 2 people cannot run terraform apply at the same time on the same resource. This is like visudo in linux.
- this because the 2 people would be writing in the statefile at the same time
- this can corrupt the state file just like the sudoerfile 
- This will shutdown the infrastructure down.

- to avoid corrupting the state file, we implement the terraform state lock. 

## Terraform State Lock
In Terraform, the state lock file is used to prevent concurrent modifications to the state file (terraform.tfstate) when working in a team environment or across multiple processes. The lock file ensures that only one user or process can modify the state at a time, preventing conflicts and maintaining the integrity of the state file.


he state lock file enables safe concurrent usage of Terraform across multiple users or processes. It prevents situations where two users or processes attempt to modify the state simultaneously, which could lead to conflicts, inconsistent state, or corruption of the state file.


Locking Duration: By default, Terraform holds the state lock for the duration of the operation that requires modifying the state file. Once the operation is complete, the lock is released. 

```
resource "aws_dynamodb_table" "dynamodb-terraform-state-lock" {
  name = "terraform-state-lock-dynamo"
  hash_key = "LockID"
  read_capacity = 20
  write_capacity = 20
 
  attribute {
    name = "LockID"
    type = "S"
  }
}
```


